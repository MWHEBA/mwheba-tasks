# نظام الحالات الديناميكي - Dynamic Status Workflow

## نظرة عامة

تم تطوير نظام إدارة حالات المهام ليكون ديناميكياً بالكامل، مما يسمح بتخصيص سير العمل حسب احتياجات المشروع.

## المميزات الجديدة

### 1. الحالات القابلة للتخصيص
- إضافة حالات جديدة غير محدودة
- تعديل الحالات الموجودة (الاسم، اللون، الأيقونة)
- حذف الحالات غير المستخدمة
- إعادة ترتيب الحالات بالسحب والإفلات

### 2. تحديد المسارات المسموحة
- لكل حالة، يمكن تحديد الحالات التالية المسموحة
- مرونة كاملة في تصميم سير العمل
- منع الانتقالات غير المنطقية

### 3. واجهة تغيير الحالة المحسّنة
- قائمة منسدلة تعرض جميع الخيارات المتاحة
- أيقونات وألوان واضحة لكل حالة
- سهولة الاستخدام والتنقل

## الحالات الافتراضية

### المسار الكامل للتصميم والطباعة:

1. **قيد الانتظار** (Pending) - رمادي
   - → جاري التصميم
   - → معلق
   - → ملغي

2. **جاري التصميم** (In Design) - أزرق
   - → في انتظار المراجعة
   - → في انتظار المواد
   - → معلق
   - → ملغي

3. **في انتظار المراجعة** (Awaiting Review) - بنفسجي
   - → ملاحظات العميل
   - → تم التصميم
   - → جاري التصميم
   - → معلق
   - → ملغي

4. **ملاحظات العميل** (Has Comments) - أحمر
   - → جاري التعديل
   - → في انتظار المواد
   - → معلق
   - → ملغي

5. **في انتظار المواد** (Awaiting Materials) - برتقالي
   - → جاري التصميم
   - → ملاحظات العميل
   - → معلق
   - → ملغي

6. **جاري التعديل** (In Editing) - كهرماني
   - → تم التعديل
   - → في انتظار المراجعة
   - → في انتظار المواد
   - → معلق
   - → ملغي

7. **تم التعديل** (Editing Completed) - أصفر
   - → تم التصميم
   - → ملاحظات العميل
   - → معلق
   - → ملغي

8. **تم التصميم** (Design Completed) - بنفسجي
   - → جاهز للمونتاج
   - → جاري الطباعة
   - → ملاحظات العميل
   - → معلق
   - → ملغي

9. **جاهز للمونتاج** (Ready for Montage) - سماوي
   - → جاري المونتاج
   - → جاري الطباعة
   - → ملاحظات العميل
   - → معلق
   - → ملغي

10. **جاري المونتاج** (In Montage) - نيلي
    - → تم المونتاج
    - → ملاحظات العميل
    - → معلق
    - → ملغي

11. **تم المونتاج** (Montage Completed) - أرجواني
    - → جاري الطباعة
    - → جاهز للتسليم
    - → ملاحظات العميل
    - → معلق
    - → ملغي

12. **جاري الطباعة** (In Printing) - تركواز
    - → جاهز للتسليم
    - → معلق
    - → ملغي

13. **جاهز للتسليم** (Ready for Delivery) - أخضر
    - → تم التسليم
    - → معلق
    - → ملغي

14. **معلق** (On Hold) - رمادي
    - → يمكن الانتقال لأي حالة غير نهائية

15. **تم التسليم** (Delivered) - زمردي ✓ نهائي
    - لا توجد انتقالات

16. **ملغي** (Cancelled) - أحمر ✓ نهائي
    - لا توجد انتقالات

## المسارات الشائعة

### المسار الطبيعي الكامل:
```
قيد الانتظار → جاري التصميم → في انتظار المراجعة → تم التصميم 
→ جاهز للمونتاج → جاري المونتاج → تم المونتاج 
→ جاري الطباعة → جاهز للتسليم → تم التسليم
```

### مسار التعديلات:
```
ملاحظات العميل → جاري التعديل → تم التعديل → تم التصميم
```

### مسارات مختصرة:
```
تم التصميم → جاري الطباعة (تخطي المونتاج)
تم المونتاج → جاهز للتسليم (تخطي الطباعة)
```

## كيفية الاستخدام

### إضافة حالة جديدة:
1. اذهب إلى "الحالات" من القائمة الرئيسية
2. اضغط "إضافة حالة جديدة"
3. أدخل البيانات:
   - الاسم
   - اللون
   - الأيقونة
   - الحالات التالية المسموحة
4. احفظ

### تعديل حالة موجودة:
1. اضغط على زر "تعديل" بجانب الحالة
2. عدّل البيانات المطلوبة
3. حدد الحالات التالية المسموحة
4. احفظ

### إعادة ترتيب الحالات:
- اسحب الحالة من أيقونة القبضة وأفلتها في المكان المطلوب

## التقنيات المستخدمة

### نموذج البيانات:
```typescript
interface TaskStatus {
  id: string;
  label: string;
  color: ColorTheme;
  icon: string;
  orderIndex: number;
  isFinished: boolean;
  isDefault?: boolean;
  isCancelled?: boolean;
  allowedNextStatuses?: string[];
  previousStatusId?: string;
}
```

### الخدمات الجديدة:
- `StatusService.getAllowedNextStatuses(statusId)` - الحصول على الحالات التالية المسموحة
- `StatusService.updateAllowedNextStatuses(statusId, allowedIds)` - تحديث الحالات المسموحة

### المكونات المحدثة:
- `TaskStateStepper` - يعرض قائمة منسدلة بالخيارات المتاحة
- `StatusSettings` - صفحة إدارة الحالات الكاملة

## الملاحظات الهامة

1. **الحالات النهائية**: لا يمكن الانتقال منها إلى أي حالة أخرى
2. **حالة "معلق"**: يمكنها الانتقال لأي حالة غير نهائية (مرونة كاملة)
3. **الحالة الافتراضية**: تُستخدم للمهام الجديدة تلقائياً
4. **الحذف**: لا يمكن حذف آخر حالة متبقية في النظام

## التوافق مع الإصدارات السابقة

النظام متوافق تماماً مع البيانات القديمة:
- الحالات القديمة تم تحويلها تلقائياً
- إذا لم تُحدد حالات تالية، يُسمح بجميع الحالات غير النهائية

## التحديثات المستقبلية المقترحة

- [ ] إضافة قوالب جاهزة لسير العمل
- [ ] استيراد/تصدير إعدادات الحالات
- [ ] إحصائيات متقدمة لكل حالة
- [ ] تنبيهات عند البقاء في حالة معينة لفترة طويلة
- [ ] صلاحيات مختلفة لتغيير الحالات حسب المستخدم

---

**تاريخ التحديث**: نوفمبر 2024
**الإصدار**: 2.0
